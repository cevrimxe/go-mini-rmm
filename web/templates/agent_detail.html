{{define "content"}}
<nav aria-label="breadcrumb" style="margin-bottom:0.5rem">
    <ul style="font-size:0.85rem">
        <li><a href="/" style="color:var(--accent)">Dashboard</a></li>
        <li>{{.Agent.Hostname}}</li>
    </ul>
</nav>

<div style="display:flex;align-items:center;gap:0.8rem;margin-bottom:1.5rem">
    <div>
        <h2 style="margin:0;display:flex;align-items:center;gap:0.6rem">
            {{.Agent.Hostname}}
            {{if eq (printf "%s" .Agent.Status) "online"}}
            <span class="badge badge-online">Online</span>
            {{else}}
            <span class="badge badge-offline">Offline</span>
            {{end}}
        </h2>
        <p style="margin:0.3rem 0 0 0;color:#6c7086;font-size:0.85rem">
            {{.Agent.OS}} &middot; {{.Agent.IP}} &middot; v{{.Agent.Version}} &middot; Last seen {{timeAgo .Agent.LastHeartbeat}}
        </p>
    </div>
</div>

<div class="grid-stats">
    <div class="stat-card">
        <h3>CPU Usage</h3>
        {{if .Metric}}
        <div class="value" style="color:{{if ge .Metric.CPUPercent 90.0}}var(--red){{else if ge .Metric.CPUPercent 70.0}}var(--yellow){{else}}var(--green){{end}}">{{printf "%.1f" .Metric.CPUPercent}}%</div>
        <div class="metric-bar" style="margin-top:0.5rem">
            <div class="metric-bar-fill {{metricColor .Metric.CPUPercent}}" style="width:{{printf "%.0f" .Metric.CPUPercent}}%"></div>
        </div>
        {{else}}<div class="value" style="color:#45475a">--</div>{{end}}
    </div>
    <div class="stat-card">
        <h3>Memory Usage</h3>
        {{if .Metric}}
        <div class="value" style="color:{{if ge .Metric.MemoryPercent 90.0}}var(--red){{else if ge .Metric.MemoryPercent 70.0}}var(--yellow){{else}}var(--green){{end}}">{{printf "%.1f" .Metric.MemoryPercent}}%</div>
        <div class="metric-bar" style="margin-top:0.5rem">
            <div class="metric-bar-fill {{metricColor .Metric.MemoryPercent}}" style="width:{{printf "%.0f" .Metric.MemoryPercent}}%"></div>
        </div>
        {{else}}<div class="value" style="color:#45475a">--</div>{{end}}
    </div>
    <div class="stat-card">
        <h3>Disk Usage</h3>
        {{if .Metric}}
        <div class="value" style="color:{{if ge .Metric.DiskPercent 90.0}}var(--red){{else if ge .Metric.DiskPercent 70.0}}var(--yellow){{else}}var(--green){{end}}">{{printf "%.1f" .Metric.DiskPercent}}%</div>
        <div class="metric-bar" style="margin-top:0.5rem">
            <div class="metric-bar-fill {{metricColor .Metric.DiskPercent}}" style="width:{{printf "%.0f" .Metric.DiskPercent}}%"></div>
        </div>
        {{else}}<div class="value" style="color:#45475a">--</div>{{end}}
    </div>
</div>

<div class="section-header">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
    Remote Terminal
</div>

<form id="cmdForm" onsubmit="sendCommand(event)" style="margin-bottom:0.8rem">
    <div style="display:flex;gap:0.5rem">
        <input type="text" id="cmdInput" placeholder="whoami, df -h, top -bn1, systemctl status..." required style="flex:1;margin:0">
        <button type="submit" style="margin:0;white-space:nowrap;background:var(--accent)">
            Run Command
        </button>
    </div>
</form>
<div id="cmdOutput" class="terminal-output" style="display:none"></div>

<div class="section-header" style="margin-top:2rem">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    Command History
</div>

<div style="overflow-x:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.04);">
<table style="margin:0">
    <thead>
        <tr>
            <th>Command</th>
            <th>Status</th>
            <th>Exit</th>
            <th>Time</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {{range .Commands}}
        <tr>
            <td><code style="font-size:0.8rem;color:#cdd6f4">{{.Command}}</code></td>
            <td>
                {{if eq (printf "%s" .Status) "done"}}
                <span class="badge badge-online">Done</span>
                {{else if eq (printf "%s" .Status) "pending"}}
                <span class="badge badge-warning">Pending</span>
                {{else if eq (printf "%s" .Status) "running"}}
                <span class="badge badge-info">Running</span>
                {{else}}
                <span class="badge badge-offline">Failed</span>
                {{end}}
            </td>
            <td><code style="font-size:0.8rem">{{.ExitCode}}</code></td>
            <td><small style="color:#6c7086">{{timeAgo .CreatedAt}}</small></td>
            <td><button class="outline secondary btn-sm" onclick="showOutput('{{.Stdout}}', '{{.Stderr}}', '{{.Command}}')">View</button></td>
        </tr>
        {{else}}
        <tr><td colspan="5" style="text-align:center;padding:1.5rem;color:#45475a">No commands executed yet.</td></tr>
        {{end}}
    </tbody>
</table>
</div>

<script>
const agentID = "{{.Agent.ID}}";

async function sendCommand(e) {
    e.preventDefault();
    const cmd = document.getElementById('cmdInput').value;
    const output = document.getElementById('cmdOutput');
    const btn = e.target.querySelector('button');
    output.style.display = 'block';
    output.textContent = '$ ' + cmd + '\n';
    btn.disabled = true;
    btn.textContent = 'Running...';

    try {
        const resp = await fetch('/api/v1/agents/' + agentID + '/command', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({command: cmd})
        });
        const data = await resp.json();

        let attempts = 0;
        const poll = setInterval(async () => {
            attempts++;
            const cmdResp = await fetch('/api/v1/agents/' + agentID + '/commands?limit=1');
            const cmds = await cmdResp.json();
            if (cmds.length > 0 && cmds[0].id === data.id && cmds[0].status !== 'pending') {
                clearInterval(poll);
                output.textContent = '$ ' + cmd + '\n' + cmds[0].stdout;
                if (cmds[0].stderr) output.textContent += '\n--- stderr ---\n' + cmds[0].stderr;
                output.textContent += '\n[exit code: ' + cmds[0].exit_code + ']';
                btn.disabled = false;
                btn.textContent = 'Run Command';
            }
            if (attempts > 30) {
                clearInterval(poll);
                output.textContent += '\n[timeout - no response after 30s]';
                btn.disabled = false;
                btn.textContent = 'Run Command';
            }
        }, 1000);
    } catch(err) {
        output.textContent += 'Error: ' + err.message;
        btn.disabled = false;
        btn.textContent = 'Run Command';
    }
}

function showOutput(stdout, stderr, cmd) {
    const output = document.getElementById('cmdOutput');
    output.style.display = 'block';
    output.textContent = '$ ' + cmd + '\n' + (stdout || '(no output)');
    if (stderr) output.textContent += '\n--- stderr ---\n' + stderr;
}

setTimeout(function(){ location.reload(); }, 30000);
</script>
{{end}}
