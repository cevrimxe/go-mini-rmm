{{define "content"}}
<h2>Alerts</h2>

<h3>Alert Rules</h3>
<form id="ruleForm" onsubmit="createRule(event)">
    <div class="grid">
        <select id="ruleMetric" required>
            <option value="">Select metric</option>
            <option value="cpu_percent">CPU %</option>
            <option value="memory_percent">Memory %</option>
            <option value="disk_percent">Disk %</option>
        </select>
        <select id="ruleOperator" required>
            <option value=">">&#62; (greater than)</option>
            <option value=">=">&#62;= (greater or equal)</option>
            <option value="<">&#60; (less than)</option>
            <option value="<=">&#60;= (less or equal)</option>
        </select>
        <input type="number" id="ruleThreshold" placeholder="Threshold (e.g. 90)" step="0.1" required>
        <button type="submit">Add Rule</button>
    </div>
</form>

<div style="overflow-x:auto">
<table>
    <thead>
        <tr>
            <th>Metric</th>
            <th>Operator</th>
            <th>Threshold</th>
            <th>Created</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="rulesBody">
        {{range .Rules}}
        <tr>
            <td>{{.Metric}}</td>
            <td>{{.Operator}}</td>
            <td>{{printf "%.1f" .Threshold}}</td>
            <td><small>{{timeAgo .CreatedAt}}</small></td>
            <td><button class="outline secondary" onclick="deleteRule({{.ID}})">Delete</button></td>
        </tr>
        {{else}}
        <tr><td colspan="5">No rules defined.</td></tr>
        {{end}}
    </tbody>
</table>
</div>

<h3 style="margin-top:2rem">Recent Alerts</h3>
<div style="overflow-x:auto">
<table>
    <thead>
        <tr>
            <th>Agent</th>
            <th>Message</th>
            <th>Resolved</th>
            <th>Time</th>
        </tr>
    </thead>
    <tbody>
        {{range .Alerts}}
        <tr>
            <td><a href="/ui/agents/{{.AgentID}}">{{.AgentID}}</a></td>
            <td>{{.Message}}</td>
            <td>
                {{if .Resolved}}
                <span class="badge badge-online">resolved</span>
                {{else}}
                <span class="badge badge-offline">active</span>
                {{end}}
            </td>
            <td><small>{{timeAgo .CreatedAt}}</small></td>
        </tr>
        {{else}}
        <tr><td colspan="4">No alerts.</td></tr>
        {{end}}
    </tbody>
</table>
</div>

<script>
async function createRule(e) {
    e.preventDefault();
    const body = {
        metric: document.getElementById('ruleMetric').value,
        operator: document.getElementById('ruleOperator').value,
        threshold: parseFloat(document.getElementById('ruleThreshold').value)
    };
    await fetch('/api/v1/alerts/rules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
    });
    location.reload();
}

async function deleteRule(id) {
    await fetch('/api/v1/alerts/rules/' + id, {method: 'DELETE'});
    location.reload();
}
</script>
{{end}}
