{{define "content"}}
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    Alert Rules
</div>

<div style="background:var(--surface);padding:1.2rem;border-radius:10px;border:1px solid rgba(255,255,255,0.05);margin-bottom:1.5rem">
    <form id="ruleForm" style="display:grid;grid-template-columns:1fr 1fr 80px 1fr auto;gap:0.6rem;align-items:end">
        <div>
            <label style="font-size:0.7rem;font-weight:600;color:var(--dim);margin-bottom:0.25rem;display:block">Metric</label>
            <select name="metric" style="margin:0">
                <option value="cpu">CPU Usage</option>
                <option value="memory">Memory Usage</option>
                <option value="disk">Disk Usage</option>
            </select>
        </div>
        <div>
            <label style="font-size:0.7rem;font-weight:600;color:var(--dim);margin-bottom:0.25rem;display:block">Operator</label>
            <select name="operator" style="margin:0">
                <option value=">">&gt; Greater than</option>
                <option value="<">&lt; Less than</option>
            </select>
        </div>
        <div>
            <label style="font-size:0.7rem;font-weight:600;color:var(--dim);margin-bottom:0.25rem;display:block">Value %</label>
            <input type="number" name="threshold" placeholder="90" min="0" max="100" style="margin:0">
        </div>
        <div>
            <label style="font-size:0.7rem;font-weight:600;color:var(--dim);margin-bottom:0.25rem;display:block">Agent</label>
            <select name="agent_id" style="margin:0">
                <option value="">All agents</option>
                {{range .Agents}}
                <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
            </select>
        </div>
        <button type="submit" class="btn-accent" style="margin:0">Add</button>
    </form>
    <p id="ruleError" class="text-muted text-sm" style="margin:0.5rem 0 0 0;color:var(--red);display:none"></p>
</div>

<div class="table-wrap" style="margin-bottom:1.5rem">
<table>
    <thead>
        <tr>
            <th>Metric</th>
            <th>Operator</th>
            <th>Threshold</th>
            <th>Agent</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {{range .Rules}}
        <tr>
            <td>
                {{if eq .Metric "cpu_percent"}}<span class="badge badge-info">CPU</span>
                {{else if eq .Metric "memory_percent"}}<span class="badge badge-warning">Memory</span>
                {{else}}<span class="badge badge-offline">Disk</span>{{end}}
            </td>
            <td><code>{{.Operator}}</code></td>
            <td><strong>{{printf "%.0f" .Threshold}}%</strong></td>
            <td>{{if .AgentID}}{{.AgentID}}{{else}}<span class="text-muted">All</span>{{end}}</td>
            <td>
                <button class="outline secondary btn-sm" onclick="if(confirm('Delete this rule?'))fetch('/api/v1/alerts/rules/'+{{.ID}},{method:'DELETE'}).then(()=>location.reload())">Delete</button>
            </td>
        </tr>
        {{else}}
        <tr><td colspan="5" style="text-align:center;padding:1.5rem;color:var(--dim)">No rules defined.</td></tr>
        {{end}}
    </tbody>
</table>
</div>

<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    Recent Alerts
</div>

<div class="table-wrap">
<table>
    <thead>
        <tr>
            <th>Agent</th>
            <th>Metric</th>
            <th>Message</th>
            <th>Time</th>
        </tr>
    </thead>
    <tbody>
        {{range .Alerts}}
        <tr>
            <td><a href="/ui/agents/{{.AgentID}}">{{.AgentID}}</a></td>
            <td>
                {{if eq .Metric "cpu"}}<span class="badge badge-info">CPU</span>
                {{else if eq .Metric "memory"}}<span class="badge badge-warning">Memory</span>
                {{else if eq .Metric "disk"}}<span class="badge badge-offline">Disk</span>
                {{else}}<span class="badge badge-offline">{{.Metric}}</span>{{end}}
            </td>
            <td>{{.Message}}</td>
            <td class="text-muted text-sm">{{timeAgo .CreatedAt}}</td>
        </tr>
        {{else}}
        <tr><td colspan="4" style="text-align:center;padding:1.5rem;color:var(--dim)">No alerts triggered yet.</td></tr>
        {{end}}
    </tbody>
</table>
</div>

<script>
document.getElementById('ruleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var form = e.target;
    var payload = {
        metric: form.metric.value,
        operator: form.operator.value,
        threshold: parseFloat(form.threshold.value) || 90,
        agent_id: form.agent_id.value || ''
    };
    var errEl = document.getElementById('ruleError');
    fetch('/api/v1/alerts/rules', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    }).then(function(r) {
        if (r.ok) return location.reload();
        return r.text().then(function(t) { errEl.textContent = t || 'Error'; errEl.style.display = 'block'; });
    }).catch(function(err) { errEl.textContent = err.message; errEl.style.display = 'block'; });
});
setTimeout(function(){ location.reload(); }, 30000);
</script>
{{end}}
